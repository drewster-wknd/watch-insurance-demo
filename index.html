<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Insurance Decision Agent</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent-color: #0f172a;
            --accent-light: #334155;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --accent-color: #f8fafc;
            --accent-light: #94a3b8;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-container {
            background: var(--bg-primary);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            backdrop-filter: blur(16px);
        }

        .message-bubble {
            animation: slideIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border-radius: 18px;
            max-width: 85%;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-left: auto;
            margin-right: 0;
        }

        .agent-message {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-left: 0;
            margin-right: auto;
            border: 1px solid var(--border-color);
        }

        .thinking-indicator {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 18px;
            padding: 16px 20px;
            margin: 16px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .thinking-dots {
            display: flex;
            gap: 4px;
        }

        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-light);
            animation: thinking 1.4s infinite ease-in-out;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        .input-section {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            border-radius: 0 0 24px 24px;
        }

        .setup-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            backdrop-filter: blur(8px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: var(--accent-color);
            color: var(--bg-primary);
        }

        .form-input {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready { background: #10b981; }
        .status-thinking { background: #f59e0b; animation: pulse 2s infinite; }
        .status-error { background: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .model-info {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .recommendation-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .recommendation-box.no-insurance {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
        <svg id="sun-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
        </svg>
        <svg id="moon-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
        </svg>
    </button>

    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                    Watch Insurance Advisor
                </h1>
                <p class="text-xl text-white opacity-90">
                    AI-powered consultation using mathematical frameworks to guide your insurance decisions
                </p>
            </div>

            <!-- Setup Panel -->
            <div id="setupPanel" class="setup-panel p-6 mb-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-primary mb-2">Configuration</h2>
                    <p class="text-secondary">Configure your AI insurance advisor</p>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-primary mb-2">OpenRouter API Key</label>
                        <input type="password" id="apiKey" placeholder="sk-or-..." 
                               class="form-input w-full px-4 py-3 rounded-lg focus:outline-none">
                        <p class="text-xs text-secondary mt-1">Your API key is stored locally and never shared</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-primary mb-2">AI Model</label>
                        <input type="text" id="aiModel" placeholder="deepseek/deepseek-r1-0528:free" 
                               class="form-input w-full px-4 py-3 rounded-lg focus:outline-none">
                        <div class="model-info">
                            Popular options: anthropic/claude-3-haiku, openai/gpt-4o-mini, deepseek/deepseek-r1-0528:free
                        </div>
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <button id="startConsultation" class="btn-primary text-white px-8 py-3 rounded-lg font-medium hover:shadow-lg transition-all">
                        Start Insurance Consultation
                    </button>
                </div>
            </div>

            <!-- Chat Interface -->
            <div id="chatInterface" class="chat-container hidden">
                <!-- Status Bar -->
                <div class="flex items-center justify-between p-4 border-b border-custom">
                    <div class="flex items-center">
                        <div id="statusIndicator" class="status-indicator status-ready"></div>
                        <span id="statusText" class="text-sm font-medium text-primary">Ready to help</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="currentModel" class="text-xs text-secondary bg-tertiary px-2 py-1 rounded"></span>
                        <button id="newConsultation" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">
                            New Consultation
                        </button>
                        <button id="showSetup" class="btn-secondary px-4 py-2 rounded-lg text-sm font-medium">
                            Settings
                        </button>
                    </div>
                </div>

                <!-- Messages -->
                <div id="messagesContainer" class="h-96 overflow-y-auto p-6 space-y-4">
                    <!-- Messages will be added here -->
                </div>

                <!-- Input Section -->
                <div class="input-section p-6">
                    <div id="inputArea" class="flex space-x-4">
                        <input type="text" id="userInput" placeholder="Tell me about your watch..." 
                               class="form-input flex-1 px-4 py-3 rounded-lg focus:outline-none">
                        <button id="sendMessage" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                            Send
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Full article content embedded as reference material
        const INSURANCE_ARTICLE = `Mathematics of Watch Insurance

Have you ever considered the mathematics of insurance? Believe it or not, insurance decisions should be based on numbers, not vibes.

So let's take a quick look at some frameworks, formulae and worked examples.

The Kelly Criterion

The Kelly criterion was originally developed for gambling and later applied to investment strategies. As collectors, it gives a precise mathematical framework for insurance decisions. Here's the formula for collectors (bear with me if you're not into numbers):

V = log (W−P) − (1−∑pi) logW − ∑ [pi log (W−ci) ]

Where:
W = Your total wealth
P = Insurance premium
pi = Probability of each type of loss
ci = Cost of each type of loss

If V is positive, get the insurance. If negative, skip it. Simple as that.

Real World Example

For a watch collector, let's make up some numbers:
Total Wealth (W): £500,000
Watch Value: £150,000
Annual Premium (P): £3,000

Estimated risks:
Total loss (theft/destruction):
Probability: 0.5% (pi = 0.005)
Cost: £150,000 (ci)

Major damage:
Probability: 2% (pi = 0.02)
Cost: £30,000 (ci)

Minor repairs:
Probability: 5% (pi = 0.05)
Cost: £5,000 (ci)

Plugging these into the formula, we get V = 0.023¹.
Since this positive, insurance makes mathematical sense here.

Deductibles

Now this is where it gets hairy. If you add a £5,000 deductible, watch what happens to the equation (where di is the new deductible for each event type):

V = ∑ [ pi log ( (W−P−di) / (W−ci) ) ]

Running the numbers again with this deductible, V drops to -0.015². In this case, insurance isn't worth it anymore!

Wealth Effects

It is logical, but worth reiterating, that the same insurance policy can simultaneously be worth it for a collector with £500k net worth and terrible value for someone worth £5m. Why? Because the Kelly criterion shows us the relative impact of a loss matters more than its absolute size.

This explains something I've observed for a while now - I know many very wealthy collectors who don't bother insuring their high end watches, while others who are perhaps worth much less, are insuring similar watches. Both groups, it turns out, are making a perfectly rational decision.

Insurance companies can offer profitable rates to both parties because they have vastly more capital than individual collectors. When you pay £3,000 for insurance that's worth £3,200 to you and £2,800 to them, everyone wins.

Important Caveats

Before you start plugging numbers into these equations, there are some limitations to be aware of:

Total Loss: The Kelly criterion struggles with scenarios involving total loss. If you're considering liability insurance which protects against losses exceeding your wealth, the formula suggests no premium is too high. This isn't realistic because even 'total financial loss' isn't infinite in impact (you still retain earning capacity, most developed nations have social safety nets, bankruptcy laws can provide some protection etc)

Future Income: The formula only considers current wealth, not future earnings potential. A 30-year-old surgeon and a 65-year-old retiree with identical current wealth should (and probably will) probably make different insurance decisions.

Risk Assessment: I used simplified probabilities, but real-world risk assessment is of course, messier. Your specific storage situation, travel habits, and wearing patterns all affect actual risk levels.

Alternatives

The Kelly criterion is inherently conservative. When you apply it to real-world insurance scenarios, it often suggests skipping optional insurance if you can absorb the loss (even if painful). This makes sense because most people are naturally risk-averse, insurance companies price policies at what the market will bear, and administrative costs and profit margins are built into premiums.

Other approaches you can look into:

Expected Value Analysis: Simply compare the expected loss (probability × impact) against premium costs. Less sophisticated but sometimes more practical.

Two-Tier Approach:
Basic insurance for catastrophic losses.
Self-insurance fund for smaller losses.

Portfolio Theory: Treat insurance as part of your overall risk management strategy, including investments and liquid assets.

Premium/Value Ratio

The premium/value ratio is basically the annual insurance premium divided by the total value of the insured watch(es). For example, if you're paying £1,000 per year to insure a £50,000 watch, your premium/value ratio is 2%.

This helps you quickly assess whether you're being overcharged. Like all rules of thumb, it is far from perfect, but it's a useful first check when shopping for insurance.

You'll notice the percentages decrease as values increase. That's because insurers benefit from the law of large numbers - larger collections typically mean more stable risk profiles and lower administrative costs relative to the insured value. 

Of course, other factors affect your premium too; things like security measures, location/storage arrangements, claims history, wearing and travel habits, as well as the number of pieces insured will all impact your risk rating.

Still, the premium/value ratio gives you a quick way to spot obviously bad deals. If someone quotes you 5% annually, they're either assuming you're incredibly risky or simply ripping you a new one.

One final note - beware of insurers who advertise seemingly low rates but then inflate values. A 1% premium sounds great until you realise they've valued your £50k watch at £75k!

Note: This is obviously not financial advice. These are general guidelines based on Kelly criterion calculations. Your specific situation will vary.`;

        class WatchInsuranceAgent {
            constructor() {
                this.apiKey = '';
                this.aiModel = 'deepseek/deepseek-r1-0528:free';
                this.conversation = [];
                this.isProcessing = false;
                this.questionCount = 0;
                this.maxQuestions = 5;
                this.userInfo = {
                    watchType: null,
                    watchValue: null,
                    netWorth: null,
                    riskTolerance: null,
                    currentSituation: null
                };
                
                this.bindEvents();
                this.initTheme();
            }

            bindEvents() {
                document.getElementById('startConsultation').addEventListener('click', () => this.startConsultation());
                document.getElementById('sendMessage').addEventListener('click', () => this.sendMessage());
                document.getElementById('newConsultation').addEventListener('click', () => this.newConsultation());
                document.getElementById('showSetup').addEventListener('click', () => this.showSetup());
                
                document.getElementById('userInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Pre-populate model field with default
                document.getElementById('aiModel').value = this.aiModel;
            }

            initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                this.updateThemeIcons(savedTheme);
            }

            startConsultation() {
                this.apiKey = document.getElementById('apiKey').value.trim();
                this.aiModel = document.getElementById('aiModel').value.trim() || 'deepseek/deepseek-r1-0528:free';

                if (!this.apiKey) {
                    alert('Please enter your OpenRouter API key');
                    return;
                }

                if (!this.aiModel) {
                    alert('Please specify an AI model');
                    return;
                }

                document.getElementById('setupPanel').classList.add('hidden');
                document.getElementById('chatInterface').classList.remove('hidden');
                
                // Update model display
                document.getElementById('currentModel').textContent = this.aiModel;
                
                this.addMessage('agent', 'Insurance Advisor', 
                    "Nice to meet you! I heard you might be interested in getting your watch insured but aren't sure if it makes sense financially. There are definitely more variables than you might think, so let's chit-chat a bit about your watch to see if we can find the best answer.\n\nTo start, what do you collect? Tell me a bit about the watch you're thinking about insuring.");
            }

            showSetup() {
                document.getElementById('setupPanel').classList.remove('hidden');
                document.getElementById('chatInterface').classList.add('hidden');
            }

            newConsultation() {
                this.conversation = [];
                this.questionCount = 0;
                this.userInfo = {
                    watchType: null,
                    watchValue: null,
                    netWorth: null,
                    riskTolerance: null,
                    currentSituation: null
                };
                document.getElementById('messagesContainer').innerHTML = '';
                this.addMessage('agent', 'Insurance Advisor', 
                    "Nice to meet you! I heard you might be interested in getting your watch insured but aren't sure if it makes sense financially. There are definitely more variables than you might think, so let's chit-chat a bit about your watch to see if we can find the best answer.\n\nTo start, what do you collect? Tell me a bit about the watch you're thinking about insuring.");
            }

            async sendMessage() {
                if (this.isProcessing) return;

                const input = document.getElementById('userInput');
                const message = input.value.trim();
                
                if (!message) return;

                input.value = '';
                this.addMessage('user', 'You', message);
                
                this.isProcessing = true;
                this.updateStatus('thinking', 'Thinking about your situation...');
                this.showThinkingIndicator();
                
                try {
                    // Check if user is asking for math explanation
                    const wantsMath = this.isAskingForMath(message);
                    
                    let response;
                    if (wantsMath && this.questionCount >= this.maxQuestions) {
                        response = await this.getMathExplanation();
                    } else {
                        response = await this.getAdvice(message);
                        this.questionCount++;
                    }
                    
                    this.hideThinkingIndicator();
                    this.addMessage('agent', 'Insurance Advisor', response);
                } catch (error) {
                    console.error('Consultation failed:', error);
                    this.hideThinkingIndicator();
                    this.addMessage('agent', 'System', `I apologize, but I encountered an error: ${error.message}. Please try again or check your API key and model configuration.`);
                } finally {
                    this.isProcessing = false;
                    this.updateStatus('ready', 'Ready to help');
                }
            }

            isAskingForMath(message) {
                const mathKeywords = [
                    'math', 'calculation', 'formula', 'numbers', 'kelly', 
                    'show me', 'explain', 'how did you', 'why', 'prove it',
                    'breakdown', 'details', 'logic'
                ];
                const lowerMessage = message.toLowerCase();
                return mathKeywords.some(keyword => lowerMessage.includes(keyword));
            }

            async getMathExplanation() {
                const context = this.buildConversationContext();
                const frameworks = this.getArticleDecisionFrameworks();
                
                const prompt = `Based on the previous conversation, provide a detailed mathematical explanation of your insurance recommendation using the Kelly Criterion and frameworks from the reference article.

CONVERSATION CONTEXT:
${context}

REFERENCE ARTICLE WITH FORMULAS:
${INSURANCE_ARTICLE}

DECISION FRAMEWORKS:
${JSON.stringify(frameworks, null, 2)}

INSTRUCTIONS:
- Show the Kelly Criterion formula: V = log (W−P) − (1−∑pi) logW − ∑ [pi log (W−ci) ]
- Plug in the actual or estimated values from our conversation
- Explain what each variable means in plain English
- Reference the premium/value ratio calculation in plain English
- Explain how wealth effects impact the decision in plain English
- Include any deductible considerations in plain English
- End with "This mathematical analysis confirms my recommendation that insurance [does/doesn't] make sense for your situation."

Provide the complete mathematical breakdown now.`;

                return await this.callModel(prompt);
            }

            // Extract key decision frameworks from the reference article
            getArticleDecisionFrameworks() {
                return {
                    kellyDefaults: {
                        totalLossProb: 0.005,  // 0.5% from article example
                        majorDamageProb: 0.02, // 2% from article example  
                        minorRepairProb: 0.05, // 5% from article example
                        totalLossCost: null,    // Will be watch value
                        majorDamageCost: null,  // Will be 20% of watch value (estimate)
                        minorRepairCost: 5000   // £5,000 from article example
                    },
                    premiumValueRatios: {
                        reasonable: 0.03,  // 3% and under typically reasonable
                        expensive: 0.05,   // 5% is getting expensive per article
                        ripoff: 0.05       // Above 5% is "ripping you a new one" per article
                    },
                    wealthThresholds: {
                        // Based on article's £500k vs £5m example
                        lowerWealth: 500000,   // £500k baseline from article
                        higherWealth: 5000000  // £5m baseline from article
                    },
                    deductibleImpact: {
                        // Article shows £5k deductible flipped decision from positive to negative
                        significantThreshold: 5000
                    }
                };
            }

            async getAdvice(userMessage) {
                const prompt = this.buildConsultationPrompt(userMessage);
                const frameworks = this.getArticleDecisionFrameworks();
                
                // Add the specific decision frameworks to the prompt
                const enhancedPrompt = prompt + `

SPECIFIC DECISION FRAMEWORKS FROM ARTICLE:
- Kelly Criterion defaults: ${JSON.stringify(frameworks.kellyDefaults, null, 2)}
- Premium/Value ratio guidelines: ${JSON.stringify(frameworks.premiumValueRatios, null, 2)}
- Wealth effect thresholds: ${JSON.stringify(frameworks.wealthThresholds, null, 2)}
- Deductible impact: ${JSON.stringify(frameworks.deductibleImpact, null, 2)}

Use these specific values when making recommendations. If user data differs significantly from article assumptions, adjust accordingly but base reasoning on article's mathematical principles.`;
                
                return await this.callModel(enhancedPrompt);
            }

            buildConsultationPrompt(userMessage) {
                const context = this.buildConversationContext();
                
                return `You are a warm, knowledgeable watch insurance advisor having a friendly conversation. You MUST base all recommendations strictly on the mathematical frameworks from the reference article below.

REFERENCE MATERIAL (YOUR DECISION LOGIC SSOT):
${INSURANCE_ARTICLE}

CRITICAL: Your final recommendation MUST be based on:
1. **Kelly Criterion Logic**: If V is positive → recommend insurance, if negative → don't recommend
2. **Premium/Value Ratios**: Use the article's guidelines (typically 1-3% reasonable, 5%+ is overpriced)
3. **Wealth Effects**: Same policy can be right for £500k person, wrong for £5m person
4. **Deductible Impact**: High deductibles often make insurance not worth it mathematically
5. **Default Assumptions** (when user doesn't provide exact info):
   - Total loss probability: 0.5% annually
   - Major damage probability: 2% annually  
   - Minor repairs probability: 5% annually

CONVERSATION GUIDELINES:
- You're having a friendly chat, not conducting an interrogation
- Ask maximum 4-5 questions total across the entire conversation, and provide a clear recommendation based on the article's frameworks at the end
- Current question count: ${this.questionCount}/${this.maxQuestions}
- **ASK ONLY ONE QUESTION PER RESPONSE** - Wait for user to answer before asking the next
- Lead the conversation naturally toward gathering key info for Kelly Criterion calculation
- Omit any math formulas, jargon, and internal notes/calculations in the responses

KEY INFO TO GATHER (for Kelly Criterion & article frameworks):
1. Watch value (essential for Kelly Criterion)
2. Their approximate net worth/wealth (W in Kelly formula)
3. Any insurance premium quotes they've received (P in Kelly formula)
4. Risk factors: storage, travel, wearing habits (affects probabilities)
5. Any deductibles being considered

${this.questionCount >= this.maxQuestions ? `
IMPORTANT: You've asked enough questions (${this.questionCount}/${this.maxQuestions}). 
Time to provide a CLEAR RECOMMENDATION based on the article's mathematical frameworks:
- Apply Kelly Criterion logic internally (without showing any calculations)
- "Based on our conversation, insurance [DOES/DOESN'T] make sense for you financially"
- Give simple reasoning in plain English (NO math explanations)
- If recommending against insurance, mention peace of mind value and self-insurance options
- **END WITH**: "Would you like me to show you the math and calculations behind this recommendation?"
- DO NOT show any calculations unless user specifically asks for them
` : `
Focus on asking ONE SINGLE QUESTION to gather info needed for the article's decision frameworks.
Questions remaining: ${this.maxQuestions - this.questionCount}
Priority order: 1) Watch value, 2) Net worth/wealth, 3) Premium quotes, 4) Risk factors, 5) Deductibles
Ask the next most important missing piece of information.
`}

${context}

User's message: "${userMessage}"

Respond warmly and conversationally. Ask ONLY ONE question at a time. If you have enough info for a recommendation, provide it with NO calculations and ask if they want to see the math.`;
            }

            buildConversationContext() {
                if (this.conversation.length === 0) return "This is the start of a watch insurance consultation.";
                
                let context = "\nConversation so far:\n";
                this.conversation.forEach(msg => {
                    context += `${msg.sender}: ${msg.content}\n\n`;
                });
                return context;
            }

            async callModel(prompt) {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${this.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Watch Insurance Advisor'
                    },
                    body: JSON.stringify({
                        model: this.aiModel,
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1200,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const errorMessage = errorData.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid response format from AI model');
                }
                
                return data.choices[0].message.content;
            }

            showThinkingIndicator() {
                const container = document.getElementById('messagesContainer');
                const thinkingDiv = document.createElement('div');
                thinkingDiv.id = 'thinkingIndicator';
                thinkingDiv.className = 'thinking-indicator';
                thinkingDiv.innerHTML = `
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                    <span class="text-sm text-secondary">Thinking about your situation...</span>
                `;
                container.appendChild(thinkingDiv);
                container.scrollTop = container.scrollHeight;
            }

            hideThinkingIndicator() {
                const indicator = document.getElementById('thinkingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }

            addMessage(role, sender, content) {
                const container = document.getElementById('messagesContainer');
                const messageDiv = document.createElement('div');
                
                const isUser = role === 'user';
                messageDiv.className = `message-bubble ${isUser ? 'user-message' : 'agent-message'} p-4`;
                
                const timestamp = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                // Check if this is a final recommendation
                const isRecommendation = content.toLowerCase().includes('based on our conversation') || 
                                       content.toLowerCase().includes('insurance makes sense') ||
                                       content.toLowerCase().includes('insurance doesn\'t make sense');
                
                let formattedContent = this.formatMessage(content);
                
                // Add special styling for recommendations
                if (isRecommendation && !isUser) {
                    const recommendsInsurance = content.toLowerCase().includes('insurance makes sense') || 
                                              content.toLowerCase().includes('insurance does make sense');
                    const boxClass = recommendsInsurance ? 'recommendation-box' : 'recommendation-box no-insurance';
                    formattedContent = `<div class="${boxClass}"><strong>Final Recommendation</strong></div>${formattedContent}`;
                }
                
                messageDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-medium text-sm">${sender}</span>
                        <span class="text-xs opacity-70">${timestamp}</span>
                    </div>
                    <div class="prose prose-sm max-w-none">
                        ${formattedContent}
                    </div>
                `;
                
                container.appendChild(messageDiv);
                container.scrollTop = container.scrollHeight;
                
                this.conversation.push({ role, sender, content, timestamp });
            }

            formatMessage(content) {
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n/g, '<br>')
                    .replace(/^/, '<p>')
                    .replace(/$/, '</p>');
            }

            updateStatus(status, text) {
                const indicator = document.getElementById('statusIndicator');
                const statusText = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${status}`;
                statusText.textContent = text;
            }

            updateThemeIcons(theme) {
                const sunIcon = document.getElementById('sun-icon');
                const moonIcon = document.getElementById('moon-icon');
                
                if (theme === 'dark') {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            if (window.agent) {
                window.agent.updateThemeIcons(newTheme);
            }
        }

        // Initialize the agent when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.agent = new WatchInsuranceAgent();
        });
    </script>
</body>

</html>

